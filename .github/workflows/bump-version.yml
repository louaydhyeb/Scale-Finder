name: Bump Version

# When this workflow runs:
# - Manual trigger with choice of major or minor version bump
# - When you push to master (optional - can be configured)

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
        default: 'minor'
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.github/workflows/*.yml'
      - 'version.properties'

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    # Only run on manual dispatch or if triggered by push
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Read current version
      id: current_version
      run: |
        if [ -f "app/version.properties" ]; then
          VERSION_NAME=$(grep "versionName=" app/version.properties | cut -d'=' -f2)
          VERSION_CODE=$(grep "versionCode=" app/version.properties | cut -d'=' -f2)
        else
          VERSION_NAME="1.0.0"
          VERSION_CODE="1"
        fi
        echo "current_version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "current_version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION_NAME (code: $VERSION_CODE)"
    
    - name: Determine version type
      id: version_type
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
        else
          # Default to minor for push events
          echo "type=minor" >> $GITHUB_OUTPUT
        fi
    
    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current_version_name }}"
        TYPE="${{ steps.version_type.outputs.type }}"
        
        # Parse current version (e.g., "1.2.3")
        IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT"
        MAJOR="${VERSION_PARTS[0]}"
        MINOR="${VERSION_PARTS[1]}"
        PATCH="${VERSION_PARTS[2]}"
        
        # Increment based on type
        if [ "$TYPE" == "major" ]; then
          MAJOR=$((MAJOR + 1))
          MINOR=0
          PATCH=0
        elif [ "$TYPE" == "minor" ]; then
          MINOR=$((MINOR + 1))
          PATCH=0
        else  # patch
          PATCH=$((PATCH + 1))
        fi
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        NEW_CODE=$(( ${{ steps.current_version.outputs.current_version_code }} + 1 ))
        
        echo "new_version_name=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_version_code=$NEW_CODE" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION (code: $NEW_CODE)"
    
    - name: Update version.properties
      run: |
        cat > app/version.properties << EOF
        versionCode=${{ steps.new_version.outputs.new_version_code }}
        versionName=${{ steps.new_version.outputs.new_version_name }}
        EOF
        echo "Updated version.properties:"
        cat app/version.properties
    
    - name: Commit version bump
      run: |
        git add app/version.properties
        git commit -m "Bump version to ${{ steps.new_version.outputs.new_version_name }} (${{ steps.new_version.outputs.new_version_code }})" || echo "No changes to commit"
    
    - name: Push changes
      run: |
        git push origin master || echo "Push failed or no changes"
    
    - name: Create summary
      run: |
        echo "## Version Bump Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous Version:** ${{ steps.current_version.outputs.current_version_name }} (${{ steps.current_version.outputs.current_version_code }})" >> $GITHUB_STEP_SUMMARY
        echo "- **New Version:** ${{ steps.new_version.outputs.new_version_name }} (${{ steps.new_version.outputs.new_version_code }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Bump Type:** ${{ steps.version_type.outputs.type }}" >> $GITHUB_STEP_SUMMARY


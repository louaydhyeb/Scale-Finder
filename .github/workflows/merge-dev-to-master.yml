name: Merge Dev to Master

# When this workflow runs:
# - Manual trigger only (button in GitHub Actions UI)
# - Safely merges dev branch into master after validation

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (major, minor, or patch)'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
        default: 'minor'
      create_tag:
        description: 'Create a tag for this release?'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-dev:
    name: Validate Dev Branch
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout dev branch
      uses: actions/checkout@v4
      with:
        ref: dev
        fetch-depth: 0
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Run tests (if they exist)
      run: ./gradlew test || echo "No tests found, skipping"
      continue-on-error: true
    
    - name: Build release APK
      run: ./gradlew assembleRelease
    
    - name: Upload release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk-dev-${{ github.sha }}
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 30

  bump-version:
    name: Bump Version
    needs: validate-dev
    runs-on: ubuntu-latest
    if: needs.validate-dev.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: dev
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Read current version
      id: current_version
      run: |
        if [ -f "app/version.properties" ]; then
          VERSION_NAME=$(grep "versionName=" app/version.properties | cut -d'=' -f2)
          VERSION_CODE=$(grep "versionCode=" app/version.properties | cut -d'=' -f2)
        else
          VERSION_NAME="1.0.0"
          VERSION_CODE="1"
        fi
        echo "current_version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "current_version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION_NAME (code: $VERSION_CODE)"
    
    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current_version_name }}"
        TYPE="${{ github.event.inputs.version_type }}"
        
        # Parse current version (e.g., "1.2.3")
        IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT"
        MAJOR="${VERSION_PARTS[0]}"
        MINOR="${VERSION_PARTS[1]}"
        PATCH="${VERSION_PARTS[2]}"
        
        # Increment based on type
        if [ "$TYPE" == "major" ]; then
          MAJOR=$((MAJOR + 1))
          MINOR=0
          PATCH=0
        elif [ "$TYPE" == "minor" ]; then
          MINOR=$((MINOR + 1))
          PATCH=0
        else  # patch
          PATCH=$((PATCH + 1))
        fi
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        NEW_CODE=$(( ${{ steps.current_version.outputs.current_version_code }} + 1 ))
        
        echo "new_version_name=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_version_code=$NEW_CODE" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION (code: $NEW_CODE)"
    
    - name: Update version.properties
      run: |
        cat > app/version.properties << EOF
        versionCode=${{ steps.new_version.outputs.new_version_code }}
        versionName=${{ steps.new_version.outputs.new_version_name }}
        EOF
        echo "Updated version.properties:"
        cat app/version.properties
    
    - name: Commit version bump to dev
      run: |
        git add app/version.properties
        git commit -m "Bump version to ${{ steps.new_version.outputs.new_version_name }} (${{ steps.new_version.outputs.new_version_code }})" || echo "No changes to commit"
        git push origin dev || echo "Push failed or no changes"

  merge-to-master:
    name: Merge Dev to Master
    needs: [validate-dev, bump-version]
    runs-on: ubuntu-latest
    if: needs.validate-dev.result == 'success' && needs.bump-version.result == 'success'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Get new version from dev
      id: version_info
      run: |
        git fetch origin dev
        git checkout dev
        if [ -f "app/version.properties" ]; then
          VERSION_NAME=$(grep "versionName=" app/version.properties | cut -d'=' -f2)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        fi
    
    - name: Merge dev into master
      run: |
        git fetch origin master
        git fetch origin dev
        git checkout master
        git merge origin/dev --no-ff -m "Merge dev into master (v${{ steps.version_info.outputs.version_name }}) [skip ci]"
        git push origin master
    
    - name: Create tag (if requested)
      if: inputs.create_tag == 'true'
      run: |
        VERSION="${{ steps.version_info.outputs.version_name }}"
        git tag -a "v$VERSION" -m "Release v$VERSION - Merged from dev"
        git push origin "v$VERSION"

  build-master:
    name: Build Master Branch
    needs: merge-to-master
    runs-on: ubuntu-latest
    if: needs.merge-to-master.result == 'success'
    
    steps:
    - name: Checkout master
      uses: actions/checkout@v4
      with:
        ref: master
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Build release APK
      run: ./gradlew assembleRelease
    
    - name: Upload master release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk-master-${{ github.sha }}
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 30
    
    - name: Get version from master
      id: release_version
      run: |
        if [ -f "app/version.properties" ]; then
          VERSION_NAME=$(grep "versionName=" app/version.properties | cut -d'=' -f2)
          echo "version=$VERSION_NAME" >> $GITHUB_OUTPUT
        fi
    
    - name: Create GitHub Release (if tag created)
      if: inputs.create_tag == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.release_version.outputs.version }}
        name: Release v${{ steps.release_version.outputs.version }}
        body: |
          Release v${{ steps.release_version.outputs.version }} merged from dev branch
          
          **Version Type:** ${{ github.event.inputs.version_type }}
          **Commit:** ${{ github.sha }}
          **Branch:** dev â†’ master
          
          Download the APK from the artifacts.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

